<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wialon Dashboard â€“ Refactored for Maintainability</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
    <style>
      :root {
        --sidebar-width: 370px;
        --main-bg: #f4f6fa;
        --card-bg: #fff;
        --border-color: #e6e7ec;
        --accent-color: #387bf9;
        --success-color: #19c37d;
        --danger-color: #f04352;
        --muted-color: #9abff7;
        --text-color-primary: #252738;
        --text-color-secondary: #697188;
        --font-inter: "Inter", Arial, sans-serif;
      }
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: var(--font-inter);
        background: var(--main-bg);
        color: var(--text-color-primary);
      }
      .app-dashboard {
        display: flex;
        min-height: 100vh;
        width: 100vw;
        overflow: hidden;
      }
      .sidebar {
        width: var(--sidebar-width);
        background: var(--card-bg);
        box-shadow: 2px 0 14px rgba(40, 40, 70, 0.08);
        border-right: 1px solid var(--border-color);
        padding: 0 0 20px 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        z-index: 2;
      }
      .sidebar h2 {
        margin: 0;
        padding: 28px 22px 14px 22px;
        font-size: 1.35rem;
        font-weight: 700;
      }
      .sidebar label {
        font-weight: 600;
        margin: 14px 0 6px 22px;
        display: block;
      }
      .sidebar select,
      .sidebar input[type="text"],
      .sidebar textarea,
      .sidebar input[type="color"] {
        width: 86%;
        margin-left: 22px;
        padding: 8px 10px;
        margin-bottom: 10px;
        border-radius: 7px;
        border: 1px solid var(--border-color);
        font-size: 1rem;
        background: #f8fafd;
        box-sizing: border-box;
      }
      .sidebar input[type="color"] {
        padding: 4px;
      }
      .sidebar button {
        margin-left: 22px;
        margin-top: 5px;
        background: var(--accent-color);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.14s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .sidebar button:hover:not(:disabled) {
        background: #2b61d3;
      }
      .sidebar button:disabled {
        background: var(--muted-color);
        cursor: not-allowed;
      }
      .sidebar .log-container {
        border-top: 1px solid var(--border-color);
        margin-top: auto;
      }
      .sidebar #log-content {
        margin: 0 22px 0 22px;
        border: 1px solid var(--border-color);
        background: #f7fafd;
        max-height: 150px;
        overflow-y: auto;
        border-radius: 8px;
        padding: 10px;
        font-size: 0.97rem;
      }
      .main-map {
        flex: 1;
        height: 100vh;
        min-width: 0;
        z-index: 2;
      }
      #map {
        height: 100%;
        width: 100%;
        min-height: 100vh;
        border-radius: 0;
      }
      @media (max-width: 1000px) {
        .sidebar {
          display: none;
        }
        #map {
          min-width: 100vw;
        }
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      /* Reusable table style for report and logs */
      .styled-table {
        border-collapse: collapse;
        width: 100%;
        font-size: 0.97em;
        margin-top: 8px;
      }
      .styled-table th,
      .styled-table td {
        border: 1px solid #ececec;
        padding: 8px 10px;
      }
      .styled-table th {
        background: #f4f8ff;
        font-weight: 600;
      }
      .styled-table tr.odd {
        background: #f8fafd;
      }
    </style>
  </head>
  <body>
    <div class="app-dashboard">
      <div class="sidebar">
        <h2>Wialon Panel</h2>
        <div style="padding: 10px 22px; border-bottom: 1px solid #e6e7ec">
          <select id="tab-selector" style="width: 100%">
            <option value="units">Units</option>
            <option value="drivers">Drivers</option>
            <option value="sensors">Sensors</option>
            <option value="commands">Commands</option>
            <option value="reports">Reports</option>
            <!-- Add more tabs if needed -->
          </select>
        </div>
        <!-- ====================== UNITS TAB ======================= -->
        <div id="tab-units" class="tab-content">
          <h3 style="margin-left: 22px">Unit Management</h3>
          <div id="units-list"></div>
        </div>
        <!-- ===================== DRIVERS TAB ====================== -->
        <div id="tab-drivers" class="tab-content">
          <h3 style="margin-left: 22px">Driver Management</h3>
          <label>Resource:</label>
          <select id="driver-resource"></select>
          <label>Driver:</label>
          <select id="driver-list"></select>
          <div style="margin: 10px 22px">
            <input type="text" id="driver-id" placeholder="ID" readonly />
            <input type="text" id="driver-name" placeholder="Name" />
            <input type="text" id="driver-code" placeholder="Code" />
            <input type="text" id="driver-phone" placeholder="Phone" />
          </div>
          <button id="driver-create">Create</button>
          <button id="driver-update">Update</button>
          <button id="driver-delete">Delete</button>
        </div>
        <!-- ===================== SENSORS TAB ====================== -->
        <div id="tab-sensors" class="tab-content">
          <h3 style="margin-left: 22px">Sensor Management</h3>
          <label>Unit:</label>
          <select id="sensor-unit"></select>
          <label>Sensor:</label>
          <select id="sensor-list"></select>
          <div style="margin: 10px 22px">
            <input type="text" id="sensor-name" placeholder="Sensor Name" />
            <input type="text" id="sensor-type" placeholder="Sensor Type" />
            <input type="text" id="sensor-metrics" placeholder="Sensor Metrics" />
            <input type="text" id="sensor-param" placeholder="Sensor Parameter" />
          </div>
          <button id="sensor-create">Create</button>
          <button id="sensor-update">Update</button>
          <button id="sensor-delete">Delete</button>
        </div>
        <!-- ===================== COMMANDS TAB ===================== -->
        <div id="tab-commands" class="tab-content">
          <h3 style="margin-left: 22px">Command Management</h3>
          <label>Unit:</label>
          <select id="command-unit"></select>
          <label>Command:</label>
          <select id="command-list"></select>
          <div style="margin: 10px 22px">
            <input type="text" id="command-name" placeholder="Command Name" />
            <input type="text" id="command-code" placeholder="Command Code" />
          </div>
          <button id="command-create">Create</button>
          <button id="command-update">Update</button>
          <button id="command-delete">Delete</button>
          <button id="command-exec" style="background: var(--success-color)">Execute</button>
        </div>
        <!-- ====================== REPORTS TAB ===================== -->
        <div id="tab-reports" class="tab-content">
          <h3 style="margin-left: 22px">Reports</h3>
          <label>Resource:</label>
          <select id="report-resource"></select>
          <label>Template:</label>
          <select id="report-template"></select>
          <label>Unit:</label>
          <select id="report-unit"></select>
          <label>Interval:</label>
          <select id="report-interval">
            <option value="86400">Last day</option>
            <option value="604800">Last week</option>
            <option value="2592000">Last month</option>
          </select>
          <button id="report-execute">Execute</button>
          <button id="report-clear">Clear</button>
          <button id="report-export" style="background: var(--success-color); display: none">
            Export to Excel
          </button>
          <div id="report-result" style="margin-top: 14px"></div>
        </div>
        <!-- ====================== LOGGING ========================= -->
        <div class="log-container">
          <p
            style="
              padding: 10px 22px;
              font-weight: bold;
              border-bottom: 1px solid var(--muted-color);
            "
          >
            Log
          </p>
          <div id="log-content"></div>
        </div>
      </div>
      <div class="main-map"><div id="map"></div></div>
    </div>

    <script>
      // ====================== GLOBAL CONSTANTS & STATE =========================
      const TOKEN = "c1099bc37c906fd0832d8e783b60ae0dD9D1A721B294486AC08F8AA3ACAC2D2FD45FF053";
      const WIALON_API_URL = "https://hst-api.wialon.com";
      const TABS = ["units", "drivers", "sensors", "commands", "reports"];
      let _RESOURCES = [],
        _UNITS = [],
        _DRIVERS = [],
        _SENSORS = [],
        _COMMANDS = [],
        _LATEST_REPORT = [];

      // ========== GENERIC HELPERS & LOGGING ================
      function log(msg) {
        $("#log-content").prepend(`<div>${msg}</div>`);
      }
      function showTab(tab) {
        $(".tab-content").removeClass("active");
        $(`#tab-${tab}`).addClass("active");
      }
      function handleError(context, error) {
        log(`[ERROR] ${context}: ${error && error.message ? error.message : error}`);
        // Can also send to remote logging here
      }
      function populateSelect($el, items, getVal, getText) {
        $el.empty().append('<option value="">-- select --</option>');
        items.forEach((i) => $el.append(`<option value="${getVal(i)}">${getText(i)}</option>`));
      }
      function reloadAllSelects() {
        // For all tabs
        populateSelect(
          $("#driver-resource"),
          _RESOURCES,
          (r) => r.getId(),
          (r) => r.getName()
        );
        populateSelect(
          $("#report-resource"),
          _RESOURCES,
          (r) => r.getId(),
          (r) => r.getName()
        );
        populateSelect(
          $("#report-unit"),
          _UNITS,
          (u) => u.getId(),
          (u) => u.getName()
        );
        populateSelect(
          $("#sensor-unit"),
          _UNITS,
          (u) => u.getId(),
          (u) => u.getName()
        );
        populateSelect(
          $("#command-unit"),
          _UNITS,
          (u) => u.getId(),
          (u) => u.getName()
        );
      }
      function showSuccess(msg) {
        log(`<span style="color:green;">${msg}</span>`);
      }
      function showWarn(msg) {
        log(`<span style="color:orange;">${msg}</span>`);
      }

      // ========== UI BINDINGS & TAB EVENTS ================
      $("#tab-selector").on("change", function () {
        showTab(this.value);
      });
      function bindTabEvents() {
        // Driver
        $("#driver-resource").on("change", (e) => loadDriversForResource(e.target.value));
        $("#driver-list").on("change", (e) => showDriverData(e.target.value));
        $("#driver-create").on("click", createDriver);
        $("#driver-update").on("click", updateDriver);
        $("#driver-delete").on("click", deleteDriver);
        // Sensor
        $("#sensor-unit").on("change", (e) => loadSensorsForUnit(e.target.value));
        $("#sensor-list").on("change", (e) => showSensorData(e.target.value));
        $("#sensor-create").on("click", createSensor);
        $("#sensor-update").on("click", updateSensor);
        $("#sensor-delete").on("click", deleteSensor);
        // Command
        $("#command-unit").on("change", (e) => loadCommandsForUnit(e.target.value));
        $("#command-list").on("change", (e) => showCommandData(e.target.value));
        $("#command-create").on("click", createCommand);
        $("#command-update").on("click", updateCommand);
        $("#command-delete").on("click", deleteCommand);
        $("#command-exec").on("click", executeCommand);
        // Report
        $("#report-resource").on("change", (e) => loadReportTemplatesForResource(e.target.value));
        $("#report-execute").on("click", executeReport);
        $("#report-clear").on("click", () => {
          $("#report-result").empty();
          $("#report-export").hide();
        });
        $("#report-export").on("click", () => exportReportToExcel(_LATEST_REPORT));
        // Units tab - refresh list
        setInterval(renderUnitsList, 5000); // Real-time every 5s
      }

      // ========== MAP INITIALIZATION ===================
      let map = L.map("map", { doubleClickZoom: false }).setView([-26.21, 28.04], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      let unitMarkers = {};
      function renderUnitsList() {
        const sess = wialon.core.Session.getInstance();
        _UNITS = sess.getItems("avl_unit") || [];
        // UI List
        let html = `<table class="styled-table"><thead>
        <tr><th>Status</th><th>Name</th><th>Driver</th><th>Info</th></tr></thead><tbody>`;
        _UNITS.forEach((unit) => {
          const pos = unit.getPosition && unit.getPosition();
          const status = getUnitStatus(unit);
          html += `<tr>
            <td>${status.icon}</td>
            <td>${unit.getName()}</td>
            <td>${getUnitDriverName(unit)}</td>
            <td>
                <a href="#" class="show-unit-info" data-id="${unit.getId()}">Details</a>
            </td>
        </tr>`;
          // Map Marker
          if (pos) {
            if (unitMarkers[unit.getId()]) {
              map.removeLayer(unitMarkers[unit.getId()]);
            }
            unitMarkers[unit.getId()] = L.marker([pos.y, pos.x], {
              icon: getStatusIcon(status.state),
            })
              .addTo(map)
              .bindPopup(`<b>${unit.getName()}</b><br>Status: ${status.label}`);
          }
        });
        html += "</tbody></table>";
        $("#units-list").html(html);
        // On details click
        $(".show-unit-info").on("click", function (e) {
          e.preventDefault();
          showUnitDetails($(this).data("id"));
        });
      }
      function getUnitStatus(unit) {
        const pos = unit.getPosition && unit.getPosition();
        if (!pos) return { label: "Offline", icon: "ðŸ”´", state: "offline" };
        // Simple demo status - use real logic (ignition, movement) as needed!
        if (pos.speed && pos.speed > 1) return { label: "Online", icon: "ðŸŸ¢", state: "online" };
        return { label: "Parked", icon: "ðŸŸ¡", state: "parked" };
      }
      function getStatusIcon(state) {
        // Returns Leaflet icon for online/parked/offline
        let color = { online: "green", parked: "orange", offline: "red" }[state] || "gray";
        return L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
        });
      }
      function getUnitDriverName(unit) {
        const driver = unit.getDriver && unit.getDriver();
        return driver && driver.n ? driver.n : "-";
      }
      function showUnitDetails(unitId) {
        const unit = _UNITS.find((u) => u.getId() == unitId);
        if (!unit) return;
        let html = `<div style="padding:8px;"><b>${unit.getName()}</b><br/>
    Status: ${getUnitStatus(unit).label}<br/>
    Driver: ${getUnitDriverName(unit)}<br/>
    Last Pos: ${unit.getPosition && unit.getPosition().y},${unit.getPosition && unit.getPosition().x}
    <br/>More info coming soon!</div>`;
        log(html);
      }

      // ========== DRIVER MANAGEMENT ==============
      function loadDriversForResource(resId) {
        let res = _RESOURCES.find((r) => r.getId() == resId);
        let drivers = res && res.getDrivers ? res.getDrivers() : [];
        populateSelect(
          $("#driver-list"),
          drivers,
          (d) => d.id,
          (d) => d.n
        );
      }
      function showDriverData(driverId) {
        let res = _RESOURCES.find((r) => r.getId() == $("#driver-resource").val());
        let driver = res && res.getDrivers ? res.getDrivers().find((d) => d.id == driverId) : null;
        if (!driver) return;
        $("#driver-id").val(driver.id);
        $("#driver-name").val(driver.n);
        $("#driver-code").val(driver.c);
        $("#driver-phone").val(driver.p);
      }
      function createDriver() {
        /* ...Implement Wialon driver creation... */ showSuccess("Driver creation (demo)");
      }
      function updateDriver() {
        /* ...Implement Wialon driver update... */ showSuccess("Driver update (demo)");
      }
      function deleteDriver() {
        /* ...Implement Wialon driver deletion... */ showWarn("Driver deletion (demo)");
      }

      // ========== SENSOR MANAGEMENT ==============
      function loadSensorsForUnit(unitId) {
        let unit = _UNITS.find((u) => u.getId() == unitId);
        let sensors = unit && unit.getSensors ? unit.getSensors() : [];
        populateSelect(
          $("#sensor-list"),
          sensors,
          (s) => s.id,
          (s) => s.n
        );
      }
      function showSensorData(sensorId) {
        let unit = _UNITS.find((u) => u.getId() == $("#sensor-unit").val());
        let sensor =
          unit && unit.getSensors ? unit.getSensors().find((s) => s.id == sensorId) : null;
        if (!sensor) return;
        $("#sensor-name").val(sensor.n);
        $("#sensor-type").val(sensor.t);
        $("#sensor-metrics").val(sensor.m);
        $("#sensor-param").val(sensor.p);
      }
      function createSensor() {
        showSuccess("Sensor creation (demo)");
      }
      function updateSensor() {
        showSuccess("Sensor update (demo)");
      }
      function deleteSensor() {
        showWarn("Sensor deletion (demo)");
      }

      // ========== COMMAND MANAGEMENT ==============
      function loadCommandsForUnit(unitId) {
        let unit = _UNITS.find((u) => u.getId() == unitId);
        let cmds = unit && unit.getCommands ? unit.getCommands() : [];
        populateSelect(
          $("#command-list"),
          cmds,
          (c) => c.id,
          (c) => c.n
        );
      }
      function showCommandData(cmdId) {
        let unit = _UNITS.find((u) => u.getId() == $("#command-unit").val());
        let cmd = unit && unit.getCommands ? unit.getCommands().find((c) => c.id == cmdId) : null;
        if (!cmd) return;
        $("#command-name").val(cmd.n);
        $("#command-code").val(cmd.c);
      }
      function createCommand() {
        showSuccess("Command creation (demo)");
      }
      function updateCommand() {
        showSuccess("Command update (demo)");
      }
      function deleteCommand() {
        showWarn("Command deletion (demo)");
      }
      function executeCommand() {
        showSuccess("Command executed (demo)");
      }

      // ========== REPORT MANAGEMENT ==============
      function loadReportTemplatesForResource(resId) {
        let res = _RESOURCES.find((r) => r.getId() == resId);
        let templates = res && res.getReportTemplates ? res.getReportTemplates() : [];
        populateSelect(
          $("#report-template"),
          templates,
          (t) => t.id,
          (t) => t.nm
        );
      }
      function executeReport() {
        const resId = $("#report-resource").val(),
          templId = $("#report-template").val(),
          unitId = $("#report-unit").val(),
          interval = parseInt($("#report-interval").val(), 10);
        if (!resId || !templId || !unitId) {
          showWarn("Choose all fields.");
          return;
        }
        let res = _RESOURCES.find((r) => r.getId() == resId);
        let now = Math.floor(Date.now() / 1000),
          from = now - interval;
        let report = {
          reportResourceId: +resId,
          reportTemplateId: +templId,
          reportObjectId: +unitId,
          reportObjectSecId: 0,
          interval: { from, to: now, flags: 0 },
        };
        $("#report-execute").prop("disabled", true).text("Running...");
        res.execReport(report, function (code, data) {
          $("#report-execute").prop("disabled", false).text("Execute");
          if (code) {
            showWarn("Failed: " + wialon.core.Errors.getErrorText(code));
            $("#report-export").hide();
            return;
          }
          let tables = data && data.tables;
          if (!tables || !tables.length) {
            showWarn("No data.");
            return;
          }
          _LATEST_REPORT = tables;
          $("#report-export").show();
          renderReportTables(tables);
        });
      }
      function renderReportTables(tables) {
        let html = "";
        tables.forEach((table, idx) => {
          html += `<h4>${table.label}</h4>
        <table class="styled-table"><thead><tr>${table.header.map((h) => `<th>${h}</th>`).join("")}</tr></thead><tbody>`;
          table.rows.forEach((row, i) => {
            html += `<tr${i % 2 ? ' class="odd"' : ""}>${row.c.map((cell) => `<td>${cell.t || cell}</td>`).join("")}</tr>`;
          });
          html += "</tbody></table>";
        });
        $("#report-result").html(html);
      }
      function exportReportToExcel(tables) {
        const wb = XLSX.utils.book_new();
        tables.forEach((table, idx) => {
          const header = table.header;
          const rows = table.rows.map((row) => row.c.map((cell) => cell.t || cell));
          const wsData = [header, ...rows];
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          XLSX.utils.book_append_sheet(
            wb,
            ws,
            table.label.substring(0, 28) || "Report" + (idx + 1)
          );
        });
        XLSX.writeFile(wb, `wialon-report-${new Date().toISOString().replace(/[:.]/g, "-")}.xlsx`);
      }

      // ========== INITIALIZE AND LOAD DATA ==============
      function initWialonAndLoadData() {
        wialon.core.Session.getInstance().initSession(WIALON_API_URL);
        wialon.core.Session.getInstance().loginToken(TOKEN, "", function (code) {
          if (code) {
            handleError("Login", wialon.core.Errors.getErrorText(code));
            return;
          }
          log("Logged in.");
          const sess = wialon.core.Session.getInstance();
          // Load all needed libraries up-front
          [
            "itemIcon",
            "resourceReports",
            "resourceDrivers",
            "resourceZones",
            "unitSensors",
            "unitCommandDefinitions",
            "resourceNotifications",
            "unitEventRegistrar",
          ].forEach((lib) => sess.loadLibrary(lib));
          sess.updateDataFlags(
            [
              {
                type: "type",
                data: "avl_unit",
                flags: wialon.item.Item.dataFlag.base | wialon.item.Unit.dataFlag.lastPosition,
                mode: 0,
              },
              {
                type: "type",
                data: "avl_resource",
                flags: wialon.item.Item.dataFlag.base | wialon.item.Resource.dataFlag.reports,
                mode: 0,
              },
            ],
            function (code) {
              if (code) {
                handleError("Data flags", wialon.core.Errors.getErrorText(code));
                return;
              }
              _RESOURCES = sess.getItems("avl_resource") || [];
              _UNITS = sess.getItems("avl_unit") || [];
              reloadAllSelects();
              renderUnitsList();
            }
          );
        });
      }
      // ========================== BOOTSTRAP ============================
      $(function () {
        showTab("units");
        bindTabEvents();
        initWialonAndLoadData();
      });
    </script>
  </body>
</html>
